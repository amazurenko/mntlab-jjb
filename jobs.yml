- job-template:
    name: '{project_name}-{student}-{type}-{child}-build-job'
    parameters:
      - dynamic-choice:
              name: BRANCH_NAME
              description: "Available options"
              script: |
                    def gitURL = "https://github.com/amazurenko/mntlab-jjb.git"
                    def command = "git ls-remote -h $gitURL"
                    def proc = command.execute()
                    proc.waitFor()              
                    def branches = proc.in.text.readLines().collect {{ 
                        it.replaceAll(/[a-z0-9]*\trefs\/heads\//, '') 
                    }}
                    return branches
    scm:
      - git:
          url: https://github.com/amazurenko/mntlab-jjb.git
          branches:
            - ${{BRANCH_NAME}}
    builders:
     - shell: |
        #!/bin/bash
        ./script.sh > output.txt && tar -czvf ${{BRANCH_NAME}}_jjb_templates.tar.gz ${{WORKSPACE}}/jobs.yml 

    publishers:
     - archive:
         artifacts: 'output.txt,master_jjb_templates.tar.gz'
         allow-empty: false
         fingerprint: false
         default-excludes: true

- job-template:
    name: '{project_name}-{student}-{type}-main-job'
    parameters:
      - dynamic-choice:
              name: BRANCH_NAME
              description: "Available options"
              script: |
                  def list = ["ekrupen","master"]
              remote: false
              read-only: false
      - extended-choice:
              name: BUILDS_TRIGGER
              description: "Available options"
              type: PT_CHECKBOX
              value: MNTLAB-ekrupen-task9-child1-build-job,MNTLAB-ekrupen-task9-child2-build-job,MNTLAB-ekrupen-task9-child3-build-job,MNTLAB-ekrupen-task9-child4-build-job
              visible-item-count: "4"
    builders:
     - shell: |
        echo "main job"
     - trigger-builds:
              - project: "${{BUILDS_TRIGGER}}"
                predefined-parameters:
                    BRANCH_NAME=${{BRANCH_NAME}}
                block: true

- job-group:
   name: '{project_name}-{student}-{type}'
   child:
    - child1
    - child2
    - child3
    - child4
   jobs:
    - '{project_name}-{student}-{type}-{child}-build-job'

- project:
    name: ekrupen
    project_name: MNTLAB
    student: ekrupen
    type: task9
    jobs:
      - '{project_name}-{student}-{type}'
      - '{project_name}-{student}-{type}-main-job'
